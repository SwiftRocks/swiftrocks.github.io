<!DOCTYPE html>
<html lang="en">

  <head>

    <script src="https://use.fontawesome.com/afd448ce82.js"></script>
    
    <!-- Meta Tag -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    
    <!-- SEO -->
    <meta name="author" content="Bruno Rocha">
    <meta name="keywords" content="iOS, Xcode, Swift, Articles, Tutorials, OBJ-C, Objective-C, Apple">
    <meta name="description" content="The Performance Trace profile allows you to debug performance issues without having to attach the device to Xcode. Let's see what we can use it for!">
    <meta name="title" content="Performance Trace Profiles in iOS: Debugging performance issues you can't reproduce">
    <meta name="url" content="https://swiftrocks.com/debugging-ios-performance-issues-you-cant-reproduce-with-performance-trace-profiles">
    <meta name="image" content="https://swiftrocks.com/images/thumbs/thumb.jpg?4">
    <meta name="copyright" content="Bruno Rocha">
    <meta name="robots" content="index,follow">

    <meta property="og:title" content="Performance Trace Profiles in iOS: Debugging performance issues you can't reproduce"/>
    <meta property="og:image" content="https://swiftrocks.com/images/thumbs/thumb.jpg?4"/>
    <meta property="og:description" content="The Performance Trace profile allows you to debug performance issues without having to attach the device to Xcode. Let's see what we can use it for!"/>
    <meta property="og:type" content="website"/>
    <meta property="og:url" content="https://swiftrocks.com/debugging-ios-performance-issues-you-cant-reproduce-with-performance-trace-profiles"/>

    <meta name="twitter:card" content="summary_large_image"/>
    <meta name="twitter:image" content="https://swiftrocks.com/images/thumbs/thumb.jpg?4"/>
    <meta name="twitter:image:alt" content="Page Thumbnail"/>
    <meta name="twitter:title" content="Performance Trace Profiles in iOS: Debugging performance issues you can't reproduce"/>
    <meta name="twitter:description" content="The Performance Trace profile allows you to debug performance issues without having to attach the device to Xcode. Let's see what we can use it for!"/>
    <meta name="twitter:site" content="@rockbruno_"/>
    
    <!-- Favicon -->
    <link rel="shortcut icon" href="images/favicon/favicon-3.ico">
    <link rel="mask-icon" href="images/favicon/favicon-3.ico">
    <link rel="apple-touch-icon" href="images/favicon/iconsmall.png">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:light,lightitalic,regular,regularitalic,medium,mediumitalic,bold,bolditalic,black,blackitalic">
    
    

  <!-- Bootstrap CSS Plugins --> 
  <link rel="stylesheet" type="text/css" href="css/bootstrap.css">
  <!-- Prism CSS Stylesheet --> 
  <link rel="stylesheet" type="text/css" href="css/prism3.css"> 
  <!-- Main CSS Stylesheet --> 
  <link rel="stylesheet" type="text/css" href="css/style43.css"> 
  <link rel="stylesheet" type="text/css" href="css/sponsor3.css">
    
    <!-- HTML5 shiv and Respond.js support IE8 or Older for HTML5 elements and media queries -->
    <!--[if lt IE 9]>
	   <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
	   <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->

  <script type="application/ld+json">
  {
"@context": "https://schema.org",
"@type": "BlogPosting",
"mainEntityOfPage": {
  "@type": "WebPage",
  "@id": "https://swiftrocks.com/debugging-ios-performance-issues-you-cant-reproduce-with-performance-trace-profiles"
},
"image": [
  "https://swiftrocks.com.com/images/logo/logo.png"
],
"datePublished": "2023-06-01T13:30:00+02:00",
"dateModified": "2023-06-01T13:30:00+02:00",
"author": {
  "@type": "Person",
  "name": "Bruno Rocha"
},
 "publisher": {
  "@type": "Organization",
  "name": "SwiftRocks",
  "logo": {
    "@type": "ImageObject",
    "url": "https://swiftrocks.com.com/images/logo/logo.png"
  }
},
"headline": "Performance Trace Profiles in iOS: Debugging performance issues you can't reproduce",
    "abstract": "The Performance Trace profile allows you to debug performance issues without having to attach the device to Xcode. Let's see what we can use it for!"
}
  </script>
    

  </head>

 <body>
      
    
    
     
    
    
  <div id="main"> 
<!-- Blog Header --> 
         <!-- Blog Post (Right Sidebar) Start --> 
   <div class="container"> 
                 <div class="col-xs-12">
                    <div class="page-body">
                    	<div class="row">
         <div><a href="https://swiftrocks.com">
           <img id="logo" alt="SwiftRocks" src="images/bg/logo.png" style="margin-top: 32px; max-width: 100%; width: auto; height: auto;"> 
         </a></div>
                            <div class="content-page" id="WRITEIT_DYNAMIC_CONTENT">
<!--WRITEIT_POST_NAME=Performance Trace Profiles in iOS: Debugging performance issues you can't reproduce-->
<!--WRITEIT_POST_HTML_NAME=debugging-ios-performance-issues-you-cant-reproduce-with-performance-trace-profiles-->

<!--Add here the additional properties that you want each page to possess.-->
<!--These properties can be used to change content in the template page or in the page itself as shown here.-->
<!--Properties must start with 'WRITEIT_POST'.-->
<!--Writeit provides and injects WRITEIT_POST_NAME and WRITEIT_POST_HTML_NAME by default.-->

<!--WRITEIT_POST_SHORT_DESCRIPTION=The Performance Trace profile allows you to debug performance issues without having to attach the device to Xcode. Let's see what we can use it for!-->

<!--DateFormat example: 2021-04-12T14:00:00+02:00-->
<!--WRITEIT_POST_SITEMAP_DATE_LAST_MOD=2023-06-01T13:30:00+02:00-->
<!--WRITEIT_POST_SITEMAP_DATE=2023-06-01T13:30:00+02:00-->

<title>Performance Trace Profiles in iOS: Debugging performance issues you can't reproduce</title>
<div class="blog-post">
  <div class="post-title-index">
    <h1>Performance Trace Profiles in iOS: Debugging performance issues you can't reproduce</h1>
  </div>  
  <div class="post-info">
    <div class="post-info-text">Published on 01 Jun 2023</div>
  </div>
<p>If you landed at this article then it's possible that you're dealing with one of the most annoying things you can face as a developer: having to investigate an issue reported by your users that <b>nobody</b> seems to be able to reproduce internally.</p>
<div class="sponsor-article-ad-auto hidden"></div>
<p>The topic of investigating <i>crashes</i> you can't reproduce is something I've already talked about here at SwiftRocks in the <a href="https://swiftrocks.com/how-to-solve-any-ios-crash-ever">"How To Solve Any iOS Crash Ever"</a> article, but what I wanted to show you today refers to a different yet equally challenging category of issues: <b>performance problems</b>, like hangs/freezing UI, slow code, unnecessary threading/concurrency, CPU/memory exceptions, and so on.</p>
<p>While some of the techniques mentioned in the crashes article can also be used to investigate performance-related problems, chances are you won't have to, because this category of issues has access to a debugging weapon so powerful that you don't even need to run the app yourself to find the exact source of the problem!</p>
<h2>Performance Trace Profiles</h2>
<p><i>Debugging Profiles</i> are relatively unknown in the iOS community (possibly because the types of problems that require them are themselves quite rare to come across), but they are my current favorite way of debugging performance-related issues.</p>
<p>The standard way of debugging performance problems is by hooking your device to Xcode's Instruments, but if you can't reproduce the issue yourself, then obviously you cannot do that. However, if you know <i>anyone</i> who can reproduce it (doesn't matter if it's a developer or a random user), you can still fully debug the problem by having them run a <b>Performance Trace</b> for you.</p>
<p><b>Profiles</b> are files you open in your iOS device to temporarily unlock features that the device wouldn't normally have access to, something you might've already experienced if you ever enrolled one of your devices to the beta OS program. What you might not know though is that there are <i>many</i> types of profiles out there that you can install, and some of them are oriented towards helping you debug issues in your apps!</p>
<p>As the name implies, the <b>Performance Trace</b> profile gives your device performance-tracing capabilities. To be more specific, it allows the device that has it to run a system trace of <b>everything</b> that is currently running on the phone, generating a trace that you can later extract and open in Instruments. In other words, it's like if you were locally running a profile build of your app, except that it doesn't require the device to be plugged anywhere and works on any device and build of your product, even the App Store ones.</p>
<p><b>Be careful though, because with this great power comes also great responsibility; the trace will capture everything that is happening on the user's phone, which includes a lot of personal/sensitive information about that particular device.</b> If you're going to be asking strangers to do this process for you, make sure this is clear to them and that you're not violating any data protection laws from your country that may apply.</p>
<h2>Running a Performance Trace</h2>
<p>Follow these steps to enable performance tracing on your device:</p>
<ol>
<li>Open Apple's <a href="https://developer.apple.com/bug-reporting/profiles-and-logs/">Profiles and Logs</a> page.</li>
<li>Find the <i>Performance Trace</i> entry in the list of profiles.</li>
<li>Download the profile and install it on the device that can reproduce the issue. (You can, for example, use AirDrop to transfer the profile from a computer to the device).</li>
<li>Restart the device if needed.</li>
<li>Go to <i>Settings > Control Center > Customize Controls</i>, and then enable the <i>Performance Trace</i> control.</li>
</ol>
<p>To run a trace, follow these steps:</p>
<ol>
<li>Open Control Center and tap on the Performance Trace control to begin tracing.</li>
<li>Open your app (if you haven't done it already), and reproduce the issue. Keep in mind that traces cannot be longer than 30 seconds.</li>
<li>After reproducing the problem, either open Control Center and tap on the Performance Trace control again to stop tracing or wait for the 30 seconds time limit (after which the trace will automatically stop itself).</li>
<li>Wait a while for your phone to process the trace. You will receive a notification when this is done containing the name of the generated file (usually <code>trace_somethingsomething.tgz</code>).</li>
<li>Either tap the notification or go to <i>Settings > Privacy > Analytics & Improvements > Analytics Data</i></li>
<li>Locate the trace in the list and send it to your Mac. Trace archives are usually a couple of hundred megabytes in size.</li>
<li>(Optional) Find the profile in <i>Settings > VPN & Device Management</i> and delete it. The profile will otherwise automatically delete itself after 7 days.</li>
</ol>
<p>From your Mac, uncompress the archive. The result will be an instruments report that you can open in Xcode.</p>
<h2>Analyzing the trace</h2>
<p>Once you open the trace you may find that Xcode will highlight the <b>System Trace</b> instrument for you, and that's exactly what you should open. Keep in mind that by default no symbols will be resolved since the trace was generated outside of Xcode, so you'll need access to the dSYMs for the build that was traced in hand in order to make sense of the report. Instruments should be able to automatically symbolicate the report if the dSYMs are in your machine, but if it doesn't do that (it almost never does for me), you can manually provide the path to the dSYMs at File -> Symbols. If that also doesn't work, the <a href="https://swiftrocks.com/reverse-engineering-xcode-issue-crash-symbol">Spotlight refreshing steps mentioned in this article</a> should do the trick.</p>
<p>I find that the best way to learn how to use this particular instrument is to <a href="https://developer.apple.com/videos/play/wwdc2016/411/">watch Apple's WWDC session about it</a>, but if you've watched it and still feel lost, the example below may help you.</p>
<p>The System Trace instrument is basically the Time Profiler on steroids. While the latter (which I'm assuming you have prior experience with) allows you to analyze the CPU usage and memory footprint of an app, System Trace does that <b>in addition</b> to providing detailed information about the state of the different threads in the app, including what's causing them to not run code (if applicable). When facing performance issues, this additional threading information can usually point you to the exact source of the problem!</p>
<p>Here's an example that shows how I usually approach performance issues. Consider this intentionally slow horrible piece of code:</p>
<pre>
<code>final class ViewController: UIViewController {</code>
<code>    let queue = DispatchQueue(label: "slow-queue")</code>
<code>    let waitSemaphore = DispatchSemaphore(value: 0)</code>
<code></code>
<code>    override func viewWillAppear(_ animated: Bool) {</code>
<code>        super.viewWillAppear(animated)</code>
<code>        queue.async {</code>
<code>            self.runVerySlowCode()</code>
<code>            self.waitSemaphore.signal()</code>
<code>        }</code>
<code>        waitSemaphore.wait()</code>
<code>        runVerySlowCode()</code>
<code>    }</code>
<code></code>
<code>    func runVerySlowCode() {</code>
<code>        var arr = Array(0...100_000)</code>
<code>        for i in (1..&lt;arr.count).reversed() {</code>
<code>            for j in 0..&lt;i where arr[j] > arr[j + 1] {</code>
<code>                arr.swapAt(j, j + 1)</code>
<code>            }</code>
<code>        }</code>
<code>    }</code>
<code>}</code>
</pre>
<p>When displayed, this view controller will run some very expensive code in a background thread, <b>block itself</b> until that finishes (because why not?), and then proceed to run the same expensive code again because we really like it. This code, which results in the main thread hanging for several seconds, is obviously terrible, but pretend that somehow this slipped into production without your knowledge, your users are now complaining, and you had someone send you a performance trace. After opening the trace, you'll see something like this:</p>
 <div class="post-image margin-top-40 margin-bottom-40"> 
  <img src="https://i.imgur.com/NbmMGSM.png" alt=""> 
 </div>
<p>The System Trace instrument tracks the state of all threads in the process, and here you can immediately see that something's wrong: the main thread is marked as <b>Blocked</b> by something for a really long time and then running non-stop for also a really long time. Each of these actions will result in the app hanging.</p>
<h2>Tips for debugging the blocked state</h2>
<p>What I really like about this instrument is that it's capable of telling you exactly <i>why</i> a thread is marked as blocked. If you change the bottom inspector to the <b>Narrative</b> mode and move the timeline to the beginning of the blocked section, the instrument will tell you that the main thread was blocked by a semaphore, which was later released by another thread:</p>
 <div class="post-image margin-top-40 margin-bottom-40"> 
  <img src="https://i.imgur.com/fvsiPfN.png" alt=""> 
 </div>
<p>Many of the elements in this view are clickable and will provide more information when highlighted. In this case, by clicking the row that mentions the semaphore, you'll be able to see in the bottom right exactly which line triggered the event (which in this case is the semaphore in <code>viewWillAppear</code>). Another useful thing you can do is tap the name of the thread that eventually released it, which will take you to it in the timeline and reveal to you what exactly this thread was doing that caused the main thread to be blocked for so long (the next thing we'll look at).</p>
<h2>Tips for debugging the excessive work</h2>
<p>These traces will eventually lead you to a thread doing a lot of expensive work, and the process to debug those is no different than using the standard Time Profiler instrument; by highlighting the suspicious area and changing the bottom inspector to the <b>Profile</b> view, we can see what the app was doing at the time.</p>
<p>I assume you already know how to use the Time Profiler so I'll skip explaining the many different ways in which you can read this data, but if you need a refresher, <a href="https://developer.apple.com/videos/play/wwdc2019">this WWDC session</a> should cover what you need to know. We had two such cases (the work being done by the background thread that caused the main thread to be blocked and the work the main thread did on itself) in our example, and in any of them we can see that <code>runVerySlowCode</code> is the method to blame.</p>
 <div class="post-image margin-top-40 margin-bottom-40"> 
  <img src="https://i.imgur.com/894bK1H.png" alt="">
 </div>
<h2>What else can Performance Traces be used for?</h2>
<p>Performance Traces shine mostly in the very specific case we covered in the introduction: you are facing an issue that is connected to performance and for some reason you cannot reproduce it yourself. You could theoretically use it to gather data on more general logic/UI issues (assuming the data you're looking for would somehow materialize in the sampled stack traces), but for those cases, you'd probably find the steps defined in the <a href="https://swiftrocks.com/how-to-solve-any-ios-crash-ever">article about crashes</a> to be more effective.</p>
<div class="sponsor-article-ad-auto hidden"></div>
<p>Despite being a rare situation to come by, these traces have saved by butt every time it happened and are now one of my favorite debugging techniques for this category of issues.</p>
</div>
</div>
                              
   

    <div class="blog-post" style="margin-top: 8px; margin-bottom: 32px;">
      <div class="footer-text">
        Thanks for reading! If you want to see more content like this, follow me on <a href="https://twitter.com/rockbruno_">Twitter</a> or <a href="https://mastodon.online/@rockbruno">Mastodon</a>!
        <ul>
          <li>        <a href="https://twitter.com/intent/tweet?via=rockbruno_&hashtags=swiftrocks,ios,swiftlang&url=https%3A%2F%2Fswiftrocks.com%2Fdebugging-ios-performance-issues-you-cant-reproduce-with-performance-trace-profiles&text=Performance Trace Profiles in iOS: Debugging performance issues you can't reproduce" target="_blank" class="share">Share this page</a> on Twitter</li>
          <li>Subscribe via <a href="https://swiftrocks.com/rss.xml">RSS</a> or <a href="https://swiftrocks.us17.list-manage.com/subscribe/post?u=d6bdd39e59b8d9b8f2b8d4852&id=cbca5f3532">e-mail</a></li>
        </ul>
        <a href="https://swiftrocks.com">See all articles</a>
      </div>

    </div>

                         </div>

</div>
                        
                           
                         </div>
                     
                     
                  </div>
                  <!-- Blog Post (Right Sidebar) End -->
                
            </div>
         </div>
      </div>
    
    
    <!-- All Javascript Plugins  -->
  <script type="text/javascript" src="js/jquery.min.js"></script> 
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM" crossorigin="anonymous"></script>
  <script type="text/javascript" src="js/prism3.js"></script> 
    <!-- Main Javascript File  -->
    <script type="text/javascript" src="js/scripts29.js"></script>

<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-H8KZTWSQ1R"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-H8KZTWSQ1R');
</script>

   </body>
 </html>
