<!DOCTYPE html>
<html lang="en">

  <head>

    <script src="https://use.fontawesome.com/afd448ce82.js"></script>
    
    <!-- Meta Tag -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    
    <!-- SEO -->
    <meta name="author" content="Bruno Rocha">
    <meta name="keywords" content="iOS, Xcode, Swift, Articles, Tutorials, OBJ-C, Objective-C, Apple">
    <meta name="description" content="If you don't know what a CPU Usage termination is, consider yourself lucky. Let's explore iOS' CPU Exceptions!">
    <meta name="title" content="Solving CPU Usage Crashes with Xcode's Energy Organizer">
    <meta name="url" content="https://swiftrocks.com/debug-cpu-exceptions-xcode-energy-reports">
    <meta name="image" content="https://swiftrocks.com/images/thumbs/debug-cpu-exceptions-xcode-energy-reports.jpg?3">
    <meta name="copyright" content="Bruno Rocha">
    <meta name="robots" content="index,follow">

    <meta property="og:title" content="Solving CPU Usage Crashes with Xcode's Energy Organizer"/>
    <meta property="og:image" content="https://swiftrocks.com/images/thumbs/debug-cpu-exceptions-xcode-energy-reports.jpg?3"/>
    <meta property="og:description" content="If you don't know what a CPU Usage termination is, consider yourself lucky. Let's explore iOS' CPU Exceptions!"/>
    <meta property="og:type" content="website"/>
    <meta property="og:url" content="https://swiftrocks.com/debug-cpu-exceptions-xcode-energy-reports"/>

    <meta name="twitter:card" content="summary_large_image"/>
    <meta name="twitter:image" content="https://swiftrocks.com/images/thumbs/debug-cpu-exceptions-xcode-energy-reports.jpg?3"/>
    <meta name="twitter:image:alt" content="Page Thumbnail"/>
    <meta name="twitter:title" content="Solving CPU Usage Crashes with Xcode's Energy Organizer"/>
    <meta name="twitter:description" content="If you don't know what a CPU Usage termination is, consider yourself lucky. Let's explore iOS' CPU Exceptions!"/>
    <meta name="twitter:site" content="@rockbruno_"/>
    
    <!-- Favicon -->
    <link rel="shortcut icon" href="images/favicon/favicon-2.ico">
    <link rel="mask-icon" href="images/favicon/favicon-2.ico">
    <link rel="apple-touch-icon" href="images/favicon/apple-touch-icon.png">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:light,lightitalic,regular,regularitalic,medium,mediumitalic,bold,bolditalic,black,blackitalic">
    
    

  <!-- Bootstrap CSS Plugins --> 
  <link rel="stylesheet" type="text/css" href="css/bootstrap.css">
  <!-- Prism CSS Stylesheet --> 
  <link rel="stylesheet" type="text/css" href="css/prism3.css"> 
  <!-- Main CSS Stylesheet --> 
  <link rel="stylesheet" type="text/css" href="css/style43.css"> 
  <link rel="stylesheet" type="text/css" href="css/sponsor2.css">
    
    <!-- HTML5 shiv and Respond.js support IE8 or Older for HTML5 elements and media queries -->
    <!--[if lt IE 9]>
	   <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
	   <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->

  <script type="application/ld+json">
  {
"@context": "https://schema.org",
"@type": "BlogPosting",
"mainEntityOfPage": {
  "@type": "WebPage",
  "@id": "https://swiftrocks.com/debug-cpu-exceptions-xcode-energy-reports"
},
"image": [
  "https://swiftrocks.com.com/images/logo/logo.png"
],
"datePublished": "2021-09-28T14:00:00+02:00",
"dateModified": "2021-09-28T14:00:00+02:00",
"author": {
  "@type": "Person",
  "name": "Bruno Rocha"
},
 "publisher": {
  "@type": "Organization",
  "name": "SwiftRocks",
  "logo": {
    "@type": "ImageObject",
    "url": "https://swiftrocks.com.com/images/logo/logo.png"
  }
},
"headline": "Solving CPU Usage Crashes with Xcode's Energy Organizer",
    "abstract": "If you don't know what a CPU Usage termination is, consider yourself lucky. Let's explore iOS' CPU Exceptions!"
}
  </script>
    

  </head>

 <body>
      
    
    
     
    
    
  <div id="main"> 
<!-- Blog Header --> 
         <!-- Blog Post (Right Sidebar) Start --> 
   <div class="container"> 
                 <div class="col-xs-12">
                    <div class="page-body">
                    	<div class="row">
         <div><a href="https://swiftrocks.com">
           <img id="logo" alt="SwiftRocks" src="images/bg/logo.png" style="margin-top: 32px; max-width: 100%; width: auto; height: auto;"> 
         </a></div>
                            <div class="content-page" id="WRITEIT_DYNAMIC_CONTENT">
<!--WRITEIT_POST_NAME=Solving CPU Usage Crashes with Xcode's Energy Organizer-->
<!--WRITEIT_POST_HTML_NAME=debug-cpu-exceptions-xcode-energy-reports-->

<!--Add here the additional properties that you want each page to possess.-->
<!--These properties can be used to change content in the template page or in the page itself as shown here.-->
<!--Properties must start with 'WRITEIT_POST'.-->
<!--Writeit provides and injects WRITEIT_POST_NAME and WRITEIT_POST_HTML_NAME by default.-->

<!--WRITEIT_POST_SHORT_DESCRIPTION=If you don't know what a CPU Usage termination is, consider yourself lucky. Let's explore iOS' CPU Exceptions!-->

<!--DateFormat example: 2021-09-28T14:00:00+02:00-->
<!--WRITEIT_POST_SITEMAP_DATE_LAST_MOD=2021-09-28T14:00:00+02:00-->
<!--WRITEIT_POST_SITEMAP_DATE=2021-09-28T14:00:00+02:00-->

<title>Solving CPU Usage Crashes with Xcode's Energy Organizer</title>
<div class="blog-post">
  <div class="post-title-index">
    <h1>Solving CPU Usage Crashes with Xcode's Energy Organizer</h1>
  </div>  
  <div class="post-info">
    <div class="category category-compiler">iOS</div>
    <div class="post-info-text">Published on 28 Sep 2021</div>
  </div>
<p>If you don't know what a CPU Usage termination is, consider yourself lucky. Not only this is one of the nastiest crashes you can get in iOS, but it's also not even considered as a crash by the system. These terminations are not reported to crash providers like Firebase, so if your app has a severe high CPU usage crash, you won't even know about it until your users start reporting it to you. Really nasty stuff!</p>
<div class="sponsor-article-ad-auto hidden"></div>
<p>If you found this article by googling "how the hell do I solve this CPU usage thing?", you're in good hands. I experienced some of these crashes recently, and after suffering due to the lack of proper documentation from Apple explaining this issue, I was able to aggregate several pieces of scattered information about this on the web. Let's explore iOS' CPU Exceptions!</p>
<h2>What are CPU Exceptions in iOS?</h2>
<p>According to Apple, your app is free to destroy the phone's CPU -- as long as it's running in the foreground and not doing it for a very long time. If your app is running in the <i>background</i> however, you need to cut back on CPU usage. It's not necessarily a problem to have an expensive task in the background once, but if you're consistently using over 80% CPU over a period of one minute, iOS will kill your app without warning. This is called a <b>CPU Exception</b>, or a "high CPU usage termination".</p>
<p>As far as I know, this situation is only possible if your app is using a background mode (like an audio app) as regular apps can't run in the background for large periods of time. In any case, when iOS kills your app, you'll get a report file that looks roughly like this:</p>
<pre>
<code>Event:            cpu usage</code>
<code>Action taken:     Process killed</code>
<code>CPU:              48 seconds cpu time over 52 seconds (93% cpu average), exceeding limit of 80% cpu over 60 seconds</code>
<code>CPU limit:        48s</code>
<code>Limit duration:   60s</code>
<code>CPU used:         48s</code>
<code>CPU duration:     52s</code>
<code>Duration:         51.59s</code>
<code>Duration Sampled: 47.54s</code>
<code>Steps:            44</code>
<code></code>
<code>Heaviest stack for the target process:</code>
<code>(trace)</code>
</pre>
<p>If you receive one of these logs as part of a bug report, my first advice is to ignore it completely. The problem here is that the trace is completely useless -- although it tells you roughly which part of the app is hosting the problematic code, it gives you no information about what the actual problem is, and to make it worse, every trace is going to be different from each other. Remember: The issue is not that one specific piece of code is expensive, it's that you've been doing expensive things consistently for over a minute.</p>
<p>To properly debug this problem, you'll need the reports of multiple users. By having the "expensive stack trace" of multiple instances of the termination, the idea is that we can overlay them to see what they have in common, which should hopefully pinpoint the exact line of code that is bootstrapping the entire cascade that is leading to this issue.</p>
<h2>Enter Xcode's Energy Organizer</h2>
<p>As it turns out, Apple already does this for you. If you open your Xcode's Organizer and click on the <b>Energy</b>, you'll see that Apple reports to you all instances of problematic CPU/memory usage -- including cases where it decided to terminate the app! (as long as the user has agreed to share metrics with the developer)</p>
<div class="post-image">
  <img src="https://i.imgur.com/77jLQee.png" alt="Energy Organizer">
</div>
<h2>How to Symbolicate Xcode's Energy Logs</h2>
<p>If your crashes are symbolicated, you can skip to the next section. If your crashes are <b>not</b> symbolicated then it means that the app's archive wasn't created from your machine, so we need to download its dSYMs and provide them to Xcode.</p>
<p>Unfortunately, this is one of these moments where you start to rue the fact that Apple has a monopoly on iOS developer tools, but symbolicating these logs can be a pain in the ass.</p>
<ul>
<li>Make sure you have the dSYM file for the version you're trying to symbolicate. If you're archiving the app from a CI pipeline, you should make sure your pipeline is storing the dSYMs somewhere you can retrieve them later on for cases like this. Don't trust the "Download debug symbols" button in the Archive window, because that button simply doesn't work and they never bothered to fix it.</li>
<li>Now, place the dSYM zip somewhere. It doesn't matter where, because Xcode will attempt to find it through Spotlight.</li>
<li>With everything set, open the energy report, right click the stack trace and click <code>Symbolicate</code>. If it fails, it means that your computer's Spotlight failed to index the dSYM. Fortunately that's easy to fix, <a href="https://swiftrocks.com/reverse-engineering-xcode-issue-crash-symbol">and you can find the steps at the end of my article about the symbolication process.</a></li>
</ul>
<h2>Analyzing Xcode's Energy Logs</h2>
<p>I was surprised to see how detailed the Energy Organizer is, because I didn't even know it existed before I went deep into trying to find out how to solve CPU usage issues. The organizer reports several different kinds of issues, with symbols on the log indicating the issue being reported. These symbols changed across different Xcode versions, but in my Xcode 12.4, a minus sign indicates that the app crashed.</p>
<p>For <i>High CPU Usage</i> reports and terminations, an energy log contains a sampling of CPU usage taken over a period of time. But instead of showing individual traces like in a crash, the Energy Organizer instead groups similar samplings together and show you what they have in common:</p>
<div class="post-image">
  <img src="https://i.imgur.com/QiQJHpU.png" alt="Energy Organizer">
</div>
<p>The percentage represents how many times that frame appeared in all the samples, with a massive increase of it likely indicating what line of code is causing the high CPU usage. It might not necessarily indicate that this is the root of the issue, but since everyone is congregating into it, it's at the very least indicating one of the consequences of whatever is causing the issue.</p>
<p><b>If you're trying to reproduce the termination itself, you should probably grab one of your app's Release builds and run it in a real device without a debugger attached.</b> I think it's possible to get these terminations in the simulator, but in general it's always a good idea to debug this sort of problem in a production build.</p>
<h2>How to prevent and detect high CPU usage warnings?</h2>
<p>According to Apple, the problem is not that you can't use CPU in the background, it's that you need to use the proper APIs for it. If you absolutely need to do an expensive task in the background, you should be using the proper <b>background task</b> APIs. More specifically for this issue, the <a href="https://developer.apple.com/videos/play/wwdc2020/10078/#:~:text=If%20the%20foreground%20app%20grows,for%20less%20than%2050%20megabytes.">Why is my app getting killed?</a> WWDC session from 2020 recommends using the <code>BGProcessingTask</code> API, which represents an expensive task that will only be executed when the device is in an idle state (for example, charging during the night).</p>
<p>At the beginning of this article I mentioned that the system won't treat these issues as "crashes", but there's actually you can detect them. Although they are not crashes, <code>MetricKit</code> has a special diagnostic payload specifically for this problem: <code>MXCPUExceptionDiagnostic</code>.</p>
<p>If you haven't used <code>MetricKit</code> before, it works by subscribing an object to a diagnostics reporter singleton. When that is done, the system will send a report as an array of <code>MXMetricPayload</code> objects at most once per day, containing metrics from the past 24 hours and any previously undelivered daily reports. There are many interesting metrics you can extract, but in this article we're only interested in CPU Exception ones. Here's how you can implement an object that reports CPU Exceptions from a device:</p>
<pre>
<code>import MetricKit</code>
<code></code>
<code>final class CPUExceptionsReporter: NSObject, MXMetricManagerSubscriber {</code>
<code>    override init() {</code>
<code>        super.init()</code>
<code>        MXMetricManager.shared.add(self)</code>
<code>    }</code>
<code></code>
<code>    func didReceive(_ payloads: [MXMetricPayload]) {}</code>
<code>    func didReceive(_ payloads: [MXDiagnosticPayload]) {</code>
<code>        for payload in payloads {</code>
<code>            payload.cpuExceptionDiagnostics?.forEach(handleCPUException)</code>
<code>        }</code>
<code>    }</code>
<code></code>
<code>    func handleCPUException(_ diagnostic: MXCPUExceptionDiagnostic) {</code>
<code>        // Write a report to your crash reporter of choice</code>
<code>    }</code>
<code></code>
<code>    deinit {</code>
<code>        MXMetricManager.shared.remove(self)</code>
<code>    }</code>
<code>}</code>
</pre>
<div class="sponsor-article-ad-auto hidden"></div>
<p>You should be aware that <code>MetricKit</code> only reports this data once a day, so the data represents a warning/termination that happened <b>in the past</b>, very much likely in a different session entirely.</p>
</div>
</div>
                              
   

    <div class="blog-post" style="margin-top: 8px; margin-bottom: 32px;">
      <div class="footer-text">
        Thanks for reading! If you want to see more content like this, follow me on <a href="https://twitter.com/rockbruno_">Twitter!</a>
        <ul>
          <li>        <a href="https://twitter.com/intent/tweet?via=rockbruno_&hashtags=swiftrocks,ios,swiftlang&url=https%3A%2F%2Fswiftrocks.com%2Fdebug-cpu-exceptions-xcode-energy-reports&text=Solving CPU Usage Crashes with Xcode's Energy Organizer" target="_blank" class="share">Share this page</a> on Twitter</li>
          <li>Subscribe via <a href="https://swiftrocks.com/rss.xml">RSS</a> or <a href="https://swiftrocks.us17.list-manage.com/subscribe/post?u=d6bdd39e59b8d9b8f2b8d4852&id=cbca5f3532">e-mail</a></li>
        </ul>
      </div>

    </div>

                         </div>

</div>
                        
                           
                         </div>
                     
                     
                  </div>
                  <!-- Blog Post (Right Sidebar) End -->
                
            </div>
         </div>
      </div>
    
    
    <!-- All Javascript Plugins  -->
  <script type="text/javascript" src="js/jquery.min.js"></script> 
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM" crossorigin="anonymous"></script>
  <script type="text/javascript" src="js/prism3.js"></script> 
    <!-- Main Javascript File  -->
    <script type="text/javascript" src="js/scripts26.js"></script>

<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-130406165-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-130406165-1');
</script>

   </body>
 </html>
